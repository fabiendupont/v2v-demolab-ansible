---
- name: Deploy the ManageIQ daily appliance
  hosts: localhost
  connection: local
  gather_facts: no
  roles:
    - oVirt.manageiq
  post_tasks:
    - name: Add host to in memory inventory
      add_host:
        name: "{{ miq_vm_name }}.{{ miq_vm_dns_domain }}"
        ansible_user: root
        ansible_ssh_pass: "{{ miq_vm_root_password }}"
        ansible_pipelining: true
      tags:
        - inventory

- name: Install the conversion host role
  hosts: localhost
  connection: local
  gather_facts: no
  tasks:
    - block:
      - name: Check if the RPM is installed
        command: rpm -q ovirt-ansible-v2v-conversion-host
        ignore_errors: yes
        register: check_conversion_host_role_rpm

      - name: Try to install with YUM
        yum:
          name: ovirt-ansible-v2v-conversion-host
          state: latest
        when: check_conversion_host_role_rpm.rc != 0
        ignore_errors: yes
        register: conversion_host_role_yum

      - name: Install from Git repository
        command: ansible-galaxy install --roles-path roles oVirt.ovirt-ansible-v2v-conversion-host
        args:
          creates: roles/oVirt.ovirt-ansible-v2v-conversion-host
        when:
          - check_conversion_host_role_rpm.rc != 0
          - conversion_host_role_yum.rc != 0

      tags:
        - conversion_host

- name: Configure conversion hosts
  hosts: conversion_hosts
  tasks:
    - include_role:
        name: oVirt.ovirt-ansible-v2v-conversion-host
      vars:
        role_action: install
        v2v_vddk_override: true
      tags:
        - conversion_host

- name: Install V2V content
  hosts: "{{ miq_vm_name }}.{{ miq_vm_dns_domain }}"
  gather_facts: no
  vars:
    ansible_ssh_common_args: -o PubkeyAuthentication=no -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null
  pre_tasks:
    - debug:
        var: inventory_hostname
  roles:
    - fdupont.v2v-content

